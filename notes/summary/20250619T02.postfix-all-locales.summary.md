# Session Summary: prefix-all-locales 500 Error Investigation

**Date**: 2025-06-19T02
**Session**: postfix-all-locales  
**Branch**: investigate/500s

## Executive Summary

Investigated 500 errors occurring with `prefix-all-locales` routing strategy in Netlify Edge Functions. Discovered root cause is a bug in Paraglide JS 2.0.13 where the base locale doesn't get URL prefixes even when using `prefix-all-locales` strategy. Implemented a post-compilation patch as a workaround.

## Key Findings

### 1. Deno Version Investigation

**Netlify CLI Deno Version Discovery**:
- Used `netlify serve --debug` to reveal Deno runtime details
- Found Netlify CLI loads modules from `https://deno.land/std@0.170.0/`
- This corresponds to Deno ~1.26-1.30 (late 2022/early 2023)
- Local system has Deno 2.2.4 installed

**Window Object Behavior**:
- Deno 1.x: HAD window object for web compatibility
- Deno 2.0+: REMOVED window object entirely
- Current Deno 2.2.4: `typeof window === 'undefined'` returns true
- This version mismatch initially suspected but ruled out as root cause

### 2. 500 Error Root Cause Discovery

**Reproduction Pattern**:
- ‚úÖ Edge functions enabled (`edge: true`)
- ‚úÖ Prefix-all-locales strategy enabled
- ‚ùå ALL non-prerendered routes return 500:
  - `/faq` ‚Üí 500 Internal Server Error
  - `/api/calendar` ‚Üí 500 Internal Server Error
- ‚úÖ Locale-prefixed paths work: `/en/faq` ‚Üí 200 OK

**Key Insight**: Production site using standard `prefix` strategy works fine, confirming issue is specific to `prefix-all-locales`.

### 3. Paraglide Bug Analysis

**The Bug** (in `src/lib/paraglide/runtime.js` lines 659-662):
```javascript
// For base locale, don't add prefix
if (locale === baseLocale) {
    urlObj.pathname = "/" + pathSegments.join("/");
}
```

**Why It Fails**:
1. Request `/faq` ‚Üí locale detection returns "en" (baseLocale)
2. `localizeUrl("/faq", { locale: "en" })` returns `/faq` unchanged
3. No redirect occurs because `/faq` === `/faq`
4. Edge function tries to serve non-existent route ‚Üí 500 error

**Expected Behavior**: With `prefix-all-locales`, ALL locales should get prefixes, including the base locale.

### 4. Paraglide Issue History

Traced through paraglide issues:
- **Issue #230**: "Redirect loop since Paraglide SK 0.9"
  - Claimed fixed in Paraglide 2.0
  - We're using 2.0.13 but bug persists
- **Issue #217**: "Metaframework adapter overhaul"
  - Major rewrite to simplify adapters
  - Acknowledged "Re-route on sveltekit is making issues"
- **Issue #205**: "SvelteKit adapter 2.0 beta"
  - Complete rewrite for maintainability
  - Simplified to "minimal feature set"

## Implemented Solution

### Post-Compilation Patch

Added to `scripts/inlang-settings.ts` after paraglide compilation:

```javascript
function patch(filePath: string, toReplace: string, replacement: string): boolean {
    const content = fs.readFileSync(filePath, 'utf-8')
    const patchedContent = content.replace(toReplace, replacement)
    
    if (patchedContent === content) {
        return false
    }
    
    fs.writeFileSync(filePath, patchedContent)
    return true
}

// Apply patch when using prefix-all-locales
if (settings.routing?.strategy === 'prefix-all-locales') {
    if (patch(
        path.join(OUTPUT_PATH, 'runtime.js'),
        '    if (locale === baseLocale) {',
        '    if ("never-match-prefix-all-locales" === locale) {'
    )) {
        console.log(`üîß Applied prefix-all-locales patch to runtime.js`)
    } else {
        throw new Error(
            'Failed to apply prefix-all-locales patch - Paraglide runtime.js format may have changed.'
        )
    }
}
```

This ensures the baseLocale check never matches, forcing all locales to get prefixes.

## Next Steps

1. File bug report with Paraglide JS documenting this issue
2. Update our PR #325 to reference the bug and document our workaround
3. Test the patch to confirm it resolves the 500 errors
4. Consider contributing a proper fix upstream

## Alternative Workarounds Considered

1. **"zz" baseLocale hack**: Set dummy baseLocale and filter it out everywhere
   - More complex, requires shimming all imports
   - Rejected in favor of simpler patch approach

2. **Switch to standard `prefix` strategy**: Would work but doesn't meet our requirements

## Lessons Learned

1. Edge function errors can be runtime-specific even when behavior seems identical
2. Paraglide's 2.0 rewrite didn't fully resolve routing issues despite claims
3. Post-compilation patching can be a clean workaround for upstream bugs
4. Always verify that "fixed" issues are actually fixed in your use case