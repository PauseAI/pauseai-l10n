# Cloudinary Edge Functions Migration - Session Summary

**Date**: 2024-09-11
**Duration**: ~4 hours
**Goal**: Fix Cloudinary API endpoints failing with 500/406 errors in edge functions

## Problem Statement

The selfie upload feature's Cloudinary API endpoints were failing:
- 500 errors when running as edge functions (Deno runtime incompatible with Node.js Cloudinary SDK)
- 406 errors when excluded from edge functions (routing issues)

## Solution Implemented

Migrated from Cloudinary Node.js SDK to REST API implementation compatible with both Node.js and Deno.

### Key Changes

1. **Replaced Cloudinary SDK with REST API calls** (`src/lib/cloudinary.ts`)
   - Created generic `callCloudinaryAPI()` function handling both basic auth and signature-based auth
   - Implemented proper signature generation using Web Crypto API
   - Added support for array parameters and proper form data encoding

2. **Fixed authentication issues**
   - Replaced Node's `crypto` module with Web Crypto API for SHA1 hashing
   - Used `btoa()` for base64 encoding (available in both Deno and Node via SvelteKit)
   - Excluded `file` and `resource_type` parameters from signature calculation

3. **Updated all three endpoints**:
   - `/api/selfie/blur`: Fixed by fetching blurred image first, then uploading as base64 data URI
   - `/api/selfie/add-email`: Fixed by using correct `command` parameter and `public_ids` (plural)
   - `/api/selfie/remove`: Works with minimal changes

4. **Re-enabled edge functions** 
   - Removed `/api/selfie/*` from exclusion list in `scripts/exclude-from-edge-function.ts`
   - All endpoints now run as edge functions for better performance

### Technical Details

- **Signature generation**: Discovered that Cloudinary requires specific parameters excluded from signature
- **API quirks**: 
  - Context/tags endpoints require `public_ids` (plural) as array
  - Upload endpoint cannot fetch from Cloudinary's own URLs (HTTP 420 error)
- **Code clarity**: Renamed `signedParams` â†’ `allParams` and `sortedParams` â†’ `paramsToSign`

## Testing Results

All endpoints tested successfully via curl:
- âœ… Remove: Deletes images from Cloudinary
- âœ… Add-email: Adds email metadata to images  
- âœ… Blur: Applies face blurring and replaces original

## Future Localization Consideration

Analyzed the selfie page for future localization needs:
- ~20-25 user-facing strings currently embedded in Svelte component
- Proposed extracting to a markdown file with frontmatter for strings
- Would follow existing PostMeta pattern used for blog posts
- Estimated 3-4 hours to implement
- Benefits: Single file for translators, cleaner component code, Paraglide-compatible

### Proposed Structure
```markdown
---
title: Facing AI Danger
states:
  preparing:
    button: Preparing...
  ready:
    statement: I believe we should pause...
    uploadButton: ðŸ“· Upload My Photo
  [etc...]
toasts:
  uploadFailed: Upload failed. Please try again.
  [etc...]
---

## About the Campaign
[Campaign content here...]
```

## Lessons Learned

1. Edge functions require Web APIs, not Node.js-specific modules
2. Cloudinary's REST API has undocumented requirements (parameter exclusions from signatures)
3. Adding diagnostic logging early saves debugging time
4. Testing with real data (existing images) is crucial for catching edge cases

## Files Modified

- `src/lib/cloudinary.ts` - Complete rewrite for REST API
- `src/routes/api/selfie/blur/+server.ts` - Fetch-then-upload approach
- `src/routes/api/selfie/add-email/+server.ts` - Fixed API parameters
- `src/routes/api/selfie/remove/+server.ts` - Minor import changes
- `scripts/exclude-from-edge-function.ts` - Removed selfie exclusion
- `package.json` - Temporarily added js-sha1 (later removed)

## Current Status

âœ… All endpoints working in production-like environment (netlify serve)
âœ… Successfully tested full user workflow
âœ… Removed debugging statements for production readiness
âœ… Running as edge functions for improved performance