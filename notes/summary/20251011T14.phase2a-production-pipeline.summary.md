# Phase 2A: Production Webhook Pipeline - Session Summary

**Date**: 2025-10-11
**Duration**: ~6 hours
**Phase**: Phase 2A completion (production webhook infrastructure)

## Overview

Migrated from Flask direct webhook receiver (Phase 1A) to production-grade webhook pipeline with signature validation, durability, and per-campaign routing.

## Major Accomplishments

### 1. Production Webhook Architecture

**Final architecture:**
```
Cloudinary → API Gateway → Lambda (sig validation) → SQS → EC2 Ingestor → EFS
```

**Key components:**
- **Lambda validator**: Validates Cloudinary SHA-1 signatures, rejects forged webhooks
- **SQS**: 14-day message retention, DLQ for failed ingestion (3 retries)
- **REST API Gateway v1**: Required for proper integration (HTTP API v2 lacks needed features)
- **EC2 ingestor service**: Polls SQS, downloads images, writes sources/ + tiles/ to EFS

### 2. Data Migration

**Problem**: 26 images in sayno campaign had test_prototype/ public_id prefix (mismatch with asset_folder)

**Solution**:
- Used `cloudinary.uploader.rename()` to fix public_ids
- Rename preserves ALL metadata (tags, context, moderation status, timestamps)
- All 238 approved sayno images now have sayno/ prefix
- Enables reliable campaign extraction from public_id for monitoring

### 3. Terminology Adoption

**Clarified the pipeline:**
- **Ingestion**: Cloudinary approval → EFS storage (processor → ingestor)
- **Sources**: 1500×2000 JPEG archive with EXIF metadata (approved/ → sources/)
- **Tiles**: 300×400 PNG base inputs for collages (thumbnails/ → tiles/)
- **Renders**: Grid-sized images generated during collage composition (stored in collages/vN/renders/)

**Files renamed:**
- `processor.py` → `ingestor.py`
- `sqs_processor.py` → `sqs_ingestor.py`
- `collagen-processor.service` → `collagen-ingestor.service`
- Benchmark scripts updated for clarity

### 4. Deployment & Testing

- Deployed to EC2 with directory renames (approved/ → sources/, thumbnails/ → tiles/)
- System updates + kernel upgrade + reboot
- Service auto-starts on boot
- Full end-to-end testing: webhooks → Lambda → SQS → ingestor → EFS
- Sayno backfill: 238 tiles ingested in ~9.5 minutes (real-time SQS processing)

## Key Decisions

### Signature Validation Architecture

**Problem**: VTL URL-encoding broke signature validation (body transformed in transit)

**Solution**: Add Lambda layer for validation
- Lambda receives raw webhook body from API Gateway
- Validates signature before queueing to SQS
- EC2 ingestor trusts Lambda-validated messages (no redundant validation)

### Email Uniqueness Handling

**Decision**: Defer to collage generation time (Phase 2B), not ingestion

**Rationale**:
- Testing needs: Create multiple test tiles with same email
- Data preservation: Keep all approved tiles in archive
- Selection flexibility: Choose "best" tile per email at collage time

**Documented**: Issue #8

### Campaign Routing

**Challenge**: `asset_folder` not in webhook payload, can't extract via VTL

**Solution**: Extract campaign from `public_id` prefix (e.g., "sayno/image123" → "sayno")
- Required migrating 26 mismatched images first
- Now all tiles follow convention: public_id prefix = campaign
- Enables per-campaign CloudWatch metrics via SQS MessageAttributes

## Technical Challenges & Solutions

### 1. API Gateway HTTP API v2 Limitations

**Issue**: HTTP API v2 doesn't support VTL templates (needed for header extraction)

**Solution**: Switched to REST API v1
- More complex setup but supports full request transformation
- Eventually replaced VTL with Lambda for cleaner signature validation

### 2. Lambda Async Updates

**Issue**: `update-function-code` returns immediately, function goes into "Updating" state
- Subsequent operations fail with ResourceConflictException
- Sleep delays are unreliable

**Solution**: Added `aws lambda wait function-updated` to setup script
- Proper synchronization vs arbitrary sleep times

### 3. Dotenv Quoted Values

**Issue**: `.env` file had `CLOUDINARY_API_KEY="value"` with quotes
- Manual parsing included quotes in credentials
- API calls failed with "unknown api_key"

**Solution**:
- Used proper `load_dotenv()` in Python scripts
- Removed quotes + comments from EC2 `.env` file with sed

### 4. SQS Polling Performance

**Discovery**: SQS long polling is surprisingly efficient
- Expected: Batch processing with 20s delays between polls
- Actual: Near-real-time processing (1-3s per message when queue has messages)
- Long polling returns immediately when messages available
- Only waits 20s when queue is empty

## Infrastructure Created

**AWS Resources:**
- SQS queue: `collagen-webhooks` (14-day retention)
- SQS DLQ: `collagen-webhooks-dlq`
- Lambda: `collagen-webhook-validator` (128MB, Python 3.10)
- REST API: `8x2ivhd835` (regional endpoint)
- IAM roles: Lambda role, EC2 instance profile, API Gateway role
- AWS Backup: Daily EC2 snapshots (7-day retention)

**Webhook URL**: `https://8x2ivhd835.execute-api.us-east-1.amazonaws.com/prod/webhook/moderation`

## Files & Tools Created

**Setup scripts:**
- `setup/setup-phase2a-infra.sh` - Complete Phase 2A infrastructure (idempotent)
- `setup/deploy-phase2a.sh` - Deploy ingestor code + service to EC2
- `setup/collagen-ingestor.service` - Systemd service definition

**Lambda:**
- `lambda/webhook_validator.py` - Signature validation + SQS queuing

**Tools:**
- `tools/migrate_public_ids.py` - Rename images to fix prefix mismatches
- `tools/redrive_folder.py` - Enhanced with `--limit` for incremental testing
- `tools/toggle_test_image.py` - Simplified, restarts service for immediate testing

**Scripts:**
- `scripts/ingestor.py` - Core ingestion logic (renamed from processor.py)
- `scripts/sqs_ingestor.py` - SQS polling service (renamed from sqs_processor.py)

## Metrics

**Ingestion performance (sayno backfill):**
- 238 images redriven in ~2 minutes (redrive script)
- 476 webhooks fired (238 × 2: pending + approved)
- 410 SQS receives (some batching)
- 238 tiles ingested in ~9.5 minutes (real-time processing)
- Average: ~2.4s per tile (download + EXIF + resize + save)

**Storage:**
- test_prototype: 20 sources (~166KB JPEG) + 20 tiles (~175KB PNG)
- sayno: 238 sources + 238 tiles (~81MB total)

## Outstanding Items

- [ ] Push commits (b5c9c84 bugfix not yet pushed)
- [ ] Update parent issue (#7 MVP) with Phase 2A completion
- [ ] AWS Backup for EFS (deferred to Phase 3)
- [ ] CloudWatch alarms for SQS queue depth, Lambda errors (Phase 3)

## Next Session

**Phase 2B: Collage Generation & Admin Webapp (#5)**
- Implement email uniqueness at collage time (#8)
- Grid optimizer + render generation
- FastAPI admin UI for preview/publish
- Manifest generation

## Files Modified (Commits)

**f865f22**: Phase 2A complete
- 29 files changed, 9131 insertions(+), 195 deletions(-)
- Renames: processor→ingestor, approved→sources, thumbnails→tiles
- New: Lambda, SQS ingestor, setup scripts

**6dc61f1**: Added --limit to redrive_folder
**b5c9c84**: Fixed --limit 0 bug (not yet pushed)
