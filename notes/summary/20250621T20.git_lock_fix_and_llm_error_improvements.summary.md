# Git Lock Contention Fix and LLM Error Reporting Session Summary

**Date**: 2025-06-21 to 2025-06-22  
**Session**: Git Lock Fix, Error Improvements, and Netlify CI Fixes  
**Branch**: l10-preview  
**Final Commit**: e18e90b

## Problem Statement

Netlify CI/CD was experiencing Git lock contention failures when running l10n with multiple locales:
```
L10n process failed: GitError: fatal: Unable to create '/opt/build/repo/l10n-cage/.git/index.lock': File exists.
```

Additionally, LLM API error reporting was inadequate, showing massive response dumps instead of actionable information.

**Follow-up Session (2025-06-22)**: After addressing Git lock contention, discovered Netlify was caching broken l10n-cage directories between builds, causing authentication failures and wasted LLM costs. Investigation revealed multiple issues requiring comprehensive fixes.

## Root Cause Analysis

**Git Lock Contention**: While the l10n system uses a `gitQueue` with concurrency=1 to serialize high-level Git operations, simple-git was configured with `maxConcurrentProcesses: 8`, allowing multiple Git processes within a single operation to conflict over `.git/index.lock`.

**Error Reporting**: LLM API failures provided minimal useful information, and 402 billing errors lacked context about actual account status.

**Netlify Cache Issues**: Netlify was caching 10-day-old l10n-cage directories with broken Git remotes, causing authentication failures that were caught by try-catch blocks and allowing builds to continue silently, wasting LLM costs.

**LLM Translation Failures**: Debug page contained markdown anchor syntax (`{#section}`) that confused LLM translation, producing malformed HTML.

## Solutions Implemented

### 1. Git Lock Fix
- **Changed**: `MAX_CONCURRENT_PROCESSES` from 8 to 1 in `scripts/l10n/git-ops.ts`
- **Result**: Eliminates possibility of concurrent Git processes within any operation
- **Testing**: Successfully ran 32 l10n operations (de + nl locales) without conflicts

### 2. LLM Error Reporting Enhancement
- **Created**: `scripts/l10n/llm-utils.ts` module for error analysis
- **Features**:
  - Extract OpenRouter auth issues, rate limits, billing problems
  - Automatic account balance display on 402 errors
  - Clean error messages without response dumps
  - Fixed interceptor crash on GET requests

### 3. Netlify CI Cache Fix
- **Added**: CI detection in `inlang-settings.ts` to force-remove cached l10n-cage directories
- **Behavior**: When `CI=true`, automatically removes any existing l10n-cage before setup
- **Result**: Ensures clean Git state on every Netlify build

### 4. Fail-Fast Error Handling
- **Removed**: All try-catch blocks from Git authentication and branch setup functions
- **Impact**: Git authentication failures now immediately terminate builds
- **Benefit**: Prevents wasting LLM costs on broken Git states

### 5. Debug Page Fix
- **Removed**: Problematic anchor target section (`{#section}`) from debug.l10n-links.md
- **Reason**: LLM was corrupting markdown syntax during translation
- **Result**: Clean translations without malformed HTML

### 6. Cost Estimation Update
- **Updated**: Model pricing from $0 (free) to $0.0076 per thousand-word unit
- **Basis**: Actual usage data - $0.70 for 92.36k words (32 requests)
- **Impact**: Enables accurate cost planning for future l10n work

## Technical Details

**Git Architecture**: The system maintains proper separation:
- Single shared `gitQueue` (concurrency=1) across all locales
- Git commits serialized - no de/nl conflicts possible
- Parallel LLM processing maintained
- Lock contention was intra-operation, not inter-operation

**Netlify Cache Investigation**:
- Added comprehensive logging to trace Git operations
- Created build diagnostics script to inspect environment state
- Discovered 10-day-old cached directories with no Git remotes
- Solution: Clean CI environment detection and forced cleanup

**Error Reporting Flow**:
1. LLM API call fails
2. Extract detailed error info (auth, billing, rate limits)
3. For 402 errors: fetch account balance via `/credits` and `/auth/key` endpoints
4. Display clean summary
5. Throw simplified error

**Commit Strategy**:
- Created single comprehensive commit combining all fixes
- Removed temporary logging after successful diagnosis
- Used `--force-with-lease` to update l10-preview branch safely

## Testing Results

- **Local Reproduction**: Successfully reproduced Git lock contention with `PARAGLIDE_LOCALES=all`
- **Fix Validation**: 32 concurrent l10n operations completed without conflicts
- **Error Reporting**: Confirmed improved 402 error display with billing details
- **Cost Accuracy**: ~1¢ per request aligns with $0.0076 per thousand-word rate
- **Netlify Investigation**: Confirmed CI cache cleanup works (saw remove and re-clone in build logs)
- **Authentication Fix**: Git authentication errors now properly fail builds instead of continuing
- **Debug Page**: LLM translation now completes without malformed HTML errors

## Deployment Status

**Final Commit**: `e18e90b` force-pushed to `l10-preview` branch  
**Status**: ✅ **SUCCESS** - Netlify build completed successfully  
**Result**: All issues resolved:
- Clean l10n-cage setup (no cached directories)
- Proper Git authentication error handling  
- Successful LLM translations without errors
**Next Step**: Ready to merge comprehensive fixes to main

## Files Modified

- `scripts/l10n/git-ops.ts` - Reduced concurrent processes to 1, improved authentication
- `scripts/l10n/branch-safety.ts` - Removed try-catch blocks for fail-fast behavior
- `scripts/inlang-settings.ts` - Added CI cache cleanup to prevent broken Git state
- `scripts/l10n/llm-client.ts` - Added error handling and billing fetch
- `scripts/l10n/llm-utils.ts` - New error analysis and billing module
- `scripts/l10n/dry-run.ts` - Updated cost estimation rate
- `src/posts/debug.l10n-links.md` - Removed problematic anchor syntax

## Key Learnings

1. **Queue vs Process Concurrency**: Application-level queues don't prevent library-level concurrency issues
2. **Error Context Matters**: Raw API responses are less useful than extracted, actionable information
3. **Real Usage vs Estimates**: Actual cost data (1¢/request) differs significantly from API documentation claims
4. **OpenRouter Billing**: Multiple endpoints needed for complete account status picture