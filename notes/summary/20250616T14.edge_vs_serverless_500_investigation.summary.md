# 500 Error Investigation Summary - Edge Functions vs Serverless Functions

## Root Cause Analysis Complete

We have successfully reproduced and identified the root cause of 500 errors when using `prefix-all-locales` routing strategy with Netlify edge functions.

### Problem Statement

**Configuration causing 500 errors:**
1. `strategy: 'prefix-all-locales'` in `project.inlang/default-settings.js`
2. Prerender filtering enabled in `src/lib/adapter-patch-prerendered.js`
3. Multiple locales enabled (`PARAGLIDE_LOCALES=en,de`)
4. Edge functions enabled (`edge: true`)

### Investigation Results

#### Edge Functions (`edge: true`) - BROKEN ❌

**Build Configuration:**
- `USE_EDGE_FUNCTIONS = true` in `svelte.config.js`
- Functions bundling: `"render"` edge function
- Build log reference: `netlify-500-test.log`

**Test Results:**
```bash
# Non-prefixed routes (should redirect to /en/*)
curl -I http://localhost:37572/faq      → 500 Internal Server Error
curl -I http://localhost:37572/proposal → 500 Internal Server Error  
curl -I http://localhost:37572/pfp      → 500 Internal Server Error
curl -I http://localhost:37572/quotes   → 500 Internal Server Error

# Prefixed routes work correctly
curl -I http://localhost:37572/en/faq   → 200 OK
curl -I http://localhost:37572/de/faq   → 200 OK
```

**Error Pattern:**
```
HTTP/1.1 500 Internal Server Error
server: Netlify
x-nf-edge-functions: render
```

#### Serverless Functions (`edge: false`) - PARTIALLY BROKEN ⚠️

**Build Configuration:**
- `USE_EDGE_FUNCTIONS = false` in `svelte.config.js`
- Functions bundling: `"sveltekit-render.mjs"` serverless function
- Build log reference: `netlify-serverless-serve.log`

**Test Results:**
```bash
# All routes return 200 OK, but behavior is incorrect
curl -I http://localhost:37572/faq      → 200 OK (NO REDIRECT)
curl -I http://localhost:37572/proposal → 200 OK (NO REDIRECT)
curl -I http://localhost:37572/en/faq   → 200 OK
```

**Critical Issue:** Serverless functions serve content directly at non-prefixed URLs instead of redirecting:
```bash
curl -w "REDIRECT: %{redirect_url}\nFINAL_URL: %{url_effective}\nSTATUS: %{http_code}\n" \
  -s -o /dev/null http://localhost:37572/faq

REDIRECT: 
FINAL_URL: http://localhost:37572/faq  # Should be /en/faq
STATUS: 200
```

Content analysis shows the page serves at `/faq` but navigation indicates `/en/faq` is active, suggesting client-side URL fixup rather than proper server-side redirect.

### Root Cause

**The fundamental issue:** Both edge functions and serverless functions fail to properly handle `prefix-all-locales` routing when:

1. SvelteKit prerenders both prefixed (`/en/faq`, `/de/faq`) AND non-prefixed (`/faq`) routes
2. `adapter-patch-prerendered.js` filters out non-prefixed routes from prerendered paths:
   ```javascript
   builder.prerendered.paths = builder.prerendered.paths.filter((path) => {
       for (const locale of settings.locales) {
           if (path.startsWith('/' + locale)) return true
       }
       return false
   })
   ```
3. When requests arrive for non-prefixed routes:
   - **Edge functions (Deno runtime)**: Crash with 500 errors
   - **Serverless functions (Node.js runtime)**: Serve content incorrectly without redirect

### Expected vs Actual Behavior

**Expected behavior with `prefix-all-locales`:**
- `/faq` → `302 Redirect` → `/en/faq` (or user's preferred locale)

**Actual behavior:**
- **Edge functions**: `/faq` → `500 Internal Server Error`
- **Serverless functions**: `/faq` → `200 OK` with wrong URL (client-side fixup)

### Build Differences

**Edge Function Build (`netlify-500-test.log`):**
```
Edge Functions bundling                                       
────────────────────────────────────────────────────────────────
Packaging Edge Functions from .netlify/edge-functions directory:
 - render
(Edge Functions bundling completed in 12.6s)
```

**Serverless Function Build (`netlify-serverless-serve.log`):**
```
Functions bundling                                            
────────────────────────────────────────────────────────────────
Packaging Functions from .netlify/functions-internal directory:
 - sveltekit-render.mjs
(Functions bundling completed in 5.5s)
```

### Investigation Branch

All findings reproduced on branch: `investigate/500s`

**Key files modified:**
- `project.inlang/default-settings.js`: `strategy: 'prefix-all-locales'`
- `src/lib/adapter-patch-prerendered.js`: Prerender filtering enabled
- `.env`: `PARAGLIDE_LOCALES=en,de`
- `svelte.config.js`: `USE_EDGE_FUNCTIONS` toggled for testing

### Conclusions

1. **Edge functions have a fundamental incompatibility** with the current `prefix-all-locales` + prerender filtering approach
2. **Serverless functions work but incorrectly** - they avoid crashes but don't implement proper redirects
3. **Neither solution properly implements the expected routing behavior** for `prefix-all-locales` strategy
4. **The issue is not just about edge vs serverless** - it's about how paraglide routing integrates with Netlify's function runtime environments

### Recommendations

1. **Immediate workaround**: Switch to serverless functions (`edge: false`) to avoid 500 errors, but acknowledge this doesn't solve the fundamental routing issue
2. **Proper fix needed**: Investigate why paraglide's routing logic fails in both Netlify runtime environments when handling non-prefixed routes that should redirect to locale-prefixed versions
3. **Consider alternative approaches**: 
   - Remove prerender filtering and let both prefixed/non-prefixed routes be prerendered
   - Implement custom redirect logic in netlify.toml
   - Investigate if the issue exists with other deployment platforms

The core problem appears to be a deeper incompatibility between paraglide's `prefix-all-locales` routing strategy and Netlify's function runtime environments when combined with the current prerender filtering approach.