# Serverless Migration and Edge Function Mystery Investigation

**Date**: June 24, 2025  
**Context**: Follow-up to prefix-all-locales 500 error investigation, focusing on moving `/api/write` from edge to serverless functions for timeout resolution

## Problem Statement

The `/api/write` endpoint with web search functionality was hitting the 10-second edge function timeout limit, preventing the full workflow from completing. The goal was to migrate it to serverless functions which have longer execution limits.

## Key Discovery: Automatic API Route Exclusion Mystery

**Mystery Solved**: Why certain API routes (`/api/teams`, `/api/signatories`) were automatically serverless functions while others weren't.

**Root Cause**: SvelteKit automatically excludes API routes from edge functions when they are **called during server-side prerendering**. 

**Evidence**:
- `/api/teams` is called by `/teams/+page.ts` during prerendering ‚Üí automatically becomes serverless
- `/api/write` is never called during prerendering ‚Üí stays in edge function
- This explains the "automatic exclusion" pattern we observed in `.netlify/edge-functions/manifest.json`

**Documentation**: Created `/notes/SvelteKit_API_Route_Edge_Function_Mystery.md` explaining this discovery.

## Solution Implementation

### Configuration Changes Made

**File**: `svelte.config.js`

1. **Changed edge function setting**:
   ```diff
   - export const USE_EDGE_FUNCTIONS = true
   + export const USE_EDGE_FUNCTIONS = false
   ```

2. **Added split configuration**:
   ```diff
   adapter: adapterPatchPrerendered(
     adapterNetlify({
   -   edge: USE_EDGE_FUNCTIONS
   +   edge: USE_EDGE_FUNCTIONS,
   +   split: true
     })
   ),
   ```

### Failed Approach: `edge: true, split: true`

**Error**: `Cannot use 'split: true' alongside 'edge: true'`  
**Reason**: Netlify adapter doesn't allow both options simultaneously

### Successful Approach: `edge: false, split: true`

**Result**: All API routes become individual serverless functions:
```
Packaging Functions from .netlify/functions-internal directory:
 - sveltekit-api-calendar.mjs
 - sveltekit-api-chat.mjs  
 - sveltekit-api-geo.mjs
 - sveltekit-api-locale-env.mjs
 - sveltekit-api-national-groups.mjs (/api/teams)
 - sveltekit-api-test-edge-json.mjs
 - sveltekit-api-test-edge.mjs
 - sveltekit-api-test-svelte-pattern.mjs
 - sveltekit-api-verify.mjs
 - sveltekit-api-write.mjs ‚Üê TARGET ACHIEVED
```

## Testing Results

### Basic Functionality ‚úÖ
- `/write` page loads correctly
- `/api/write` GET returns `{"apiAvailable":true}` 
- `/api/teams` still works (now as `sveltekit-api-national-groups.mjs`)

### Web Search Functionality ‚úÖ (with timeout)
**Test**: Edinburgh AI safety research request
- **Execution**: Successfully performed 3 web searches
- **Duration**: ~67 seconds total processing time
- **Output**: Comprehensive response with 5 AI safety individuals/organizations in Edinburgh
- **Timeout**: Still hits 30-second limit (Netlify CLI limitation)

### API Usage Pattern Discovered
The `/api/write` endpoint expects:
1. **Initial request**: Conversation array format to get `stateToken`
   ```json
   [{"content":"[1]Target info:\nEdinburgh AI safety\n\n","role":"user"}]
   ```
2. **Continue request**: Use `stateToken` to proceed with workflow
   ```json
   {"stateToken": "...", "continue": true}
   ```

## Timeout Analysis & Clarification

**Previous Understanding**: Edge functions (10s) vs Serverless functions (15m)  
**Corrected Understanding** (from Anthony):
- **Edge functions**: 10-second timeout
- **Regular serverless functions**: 30-second timeout  
- **Background serverless functions**: 15-minute timeout (paid tier required)

**Current Status**: `/api/write` moved from 10s to 30s timeout, but still insufficient for full web search workflow (~67s needed).

## Production Implications

### For Immediate Deployment
- ‚úÖ **Infrastructure working**: All API routes successfully migrated to serverless
- ‚úÖ **Web search functional**: Core functionality validated
- ‚ö†Ô∏è **Timeout constraint**: 30s limit still restrictive for complex workflows

### For Full Web Search Support
**Options**:
1. **Upgrade to background functions** (paid tier) for 15-minute timeout
2. **Optimize workflow** to complete within 30 seconds
3. **Split into smaller requests** to stay under timeout limits
4. **Async processing** with polling for results

## Files Modified

- `svelte.config.js`: Edge function configuration changes
- `.netlify/edge-functions/manifest.json`: Automatically updated to reflect new serverless functions

## Lessons Learned

1. **Netlify adapter constraints**: `edge: true` and `split: true` are mutually exclusive
2. **Automatic exclusion mechanism**: Prerender-time API calls become serverless automatically
3. **Timeout hierarchy**: Edge (10s) < Serverless (30s) < Background (15m)
4. **Development vs production**: Local Netlify CLI timeouts may differ from production limits

## Next Steps

1. **Immediate**: Test deployment to production to verify timeout behavior
2. **Short-term**: Evaluate if 30-second serverless functions are sufficient for basic workflows
3. **Long-term**: Consider background functions for complex web search workflows if needed
4. **Alternative**: Implement async processing pattern for long-running requests

## Impact

‚úÖ **Primary goal achieved**: `/api/write` successfully migrated from edge to serverless functions  
‚úÖ **Knowledge gained**: Comprehensive understanding of Netlify function types and timeouts  
‚úÖ **Mystery solved**: Documented the automatic API route exclusion mechanism  
üîÑ **Timeout challenge remains**: Need to address 30s vs 67s execution time gap for full functionality