# Link Localization Implementation and Audit

**Date**: May 29, 2025  
**Session**: Link localization debugging, audit implementation, and comprehensive fixes

## Problem Statement

Localized pages (e.g., `/de/faq`, `/nl/proposal`) contained unlocalized internal links (e.g., `/proposal`, `/learn`) that should be localized to match the page's locale (e.g., `/de/proposal`, `/nl/learn`). Initial audit showed 3,644 unlocalized links across 64 HTML files.

## Investigation Process

### Initial Findings
- **Baseline audit**: 3,644 unlocalized links from localized pages requiring fixes
- **Top offenders**: `/proposal` (349×), `/xrisk` (321×), `/communities` (300×), `/action` (299×), `/join` (296×)
- **Scope**: 356 HTML files + 152 JS chunks affected

### Root Cause Analysis
1. **Component-level issues**: Some Svelte components used hardcoded `<a>` tags instead of the `Link` component
2. **CSS scoping warnings**: Components had unused CSS selectors for links
3. **Build vs runtime behavior**: JS chunks contained unlocalized links at build time but were properly localized at runtime via the custom `a` component

### Key Discovery: False Positives in JS Chunks
Through detailed investigation, we discovered that:
- **JS chunks** contain unlocalized links at build time (e.g., `/join`, `/action`)
- **Runtime behavior** correctly localizes them via the custom `a` component during hydration
- **User testing** confirmed links appear correctly localized in the DOM (e.g., `/de/join`, `/de/action`)
- **Pattern recognition**: 3 chunks per route matching our 3 locales (en, de, nl) confirmed these serve real localized pages

## Implementation

### 1. Component Fixes
Fixed hardcoded `<a>` tags in 5 components:
- **Hero.svelte**: Fixed `/join` and `/donate` links + CSS selectors
- **QuotesCarousel.svelte**: Fixed `/quotes` link + CSS selectors  
- **email-builder/+page.svelte**: Fixed `/writing-a-letter` link + renamed confusing import
- **pdoom/+page.svelte**: Fixed `/ai-takeover`, `/cybersecurity-risks`, `/join` links
- **pfp/+page.svelte**: Fixed `/2025-february` link

### 2. Homepage Block Links
**Block.svelte** required structural changes:
- Replaced `<a>` with `Link` component  
- Worked around Svelte limitation (can't apply class to components) by wrapping in div
- Fixed the 4 remaining HTML file issues: `/risks`, `/xrisk`, `/proposal`, `/action`

### 3. CSS Fixes
Resolved unused CSS selector warnings:
- **Footer**: `.c2a` → `:global(.c2a)`
- **QuotesCarousel**: `.navigation a` → `.navigation :global(a)`

### 4. Audit Script Implementation
Created `scripts/audit-unlocalized-links.ts`:
- **HTML scanning**: Finds unlocalized links in prerendered pages
- **Language switcher exclusion**: Skips `hreflang` links (intentionally unlocalized)
- **False positive filtering**: Commented out JS chunk scanning with detailed explanation
- **Progress tracking**: Clear metrics showing improvement from 3,644 → 0 links

### 5. Package.json Integration
Added `"audit:links": "tsx scripts/audit-unlocalized-links.ts"` script for ongoing monitoring

## Results

### Final Audit Results
- ✅ **0 HTML files with unlocalized links** (down from 64)
- ✅ **0 total unlocalized links found** (down from 3,644)  
- ✅ **100% reduction in user-facing link localization issues**

### Architecture Validation
Confirmed the existing link localization system works correctly:
- **Markdown pipeline**: mdsvex → custom `a` component → `localizeHref()` 
- **Component system**: Manual links use `Link` component
- **Runtime localization**: Client-side hydration properly localizes all links

## Technical Insights

### Build-time vs Runtime Localization
The investigation revealed an important architectural detail:
- **SvelteKit compiles** markdown with unlocalized links into JS chunks at build time
- **Custom `a` component** localizes these links at runtime during hydration
- **Prerendered HTML** is correctly localized, confirming the system works end-to-end
- **False positives** occurred when auditing build artifacts rather than user experience

### Audit Strategy Evolution
- **Initial approach**: Audit both HTML and JS chunks
- **Refined approach**: Focus only on HTML (actual user experience)
- **Key learning**: Build artifacts don't reflect runtime behavior in client-side localization systems

## Impact

This work eliminates all user-facing link localization issues while providing ongoing monitoring capability. Users visiting localized pages now consistently see properly localized internal links, improving navigation experience and SEO for non-English content.

The audit script provides a foundation for detecting future regressions as the website continues to evolve.