# Edge Function Investigation Summary

**Date**: 2025-06-23  
**Context**: Investigating how Netlify edge functions handle API routes, particularly `/api/write` timeout behavior

## What We Did

1. **Analyzed edge function bundle size**
   - Confirmed 3.4MB edge function on main branch
   - Identified bundled dependencies: Anthropic SDK, Airtable, full SvelteKit runtime
   - Verified this is non-ideal but working in production

2. **Tested `/api/write` routing**
   - Confirmed via `x-nf-edge-functions: render` header that it's handled by edge function
   - Successfully executed 7.2s Anthropic API call through edge function
   - Disproved initial hypothesis of serverless function proxying

3. **Created controlled delay tests**
   - Modified existing `/api/test-edge` endpoint to accept httpbin path parameter
   - Created new `/api/simple-delay` endpoint for clean testing
   - Tested various delays: 0s, 2s, 5s, 10s

4. **Verified edge function behavior**
   - All test endpoints confirmed handled by edge function via headers
   - Successfully completed 10+ second operations
   - Identified ~1s cold start overhead on first request

## What We Observed

### Edge Function Characteristics
- **Bundle**: 3.4MB containing entire server-side application
- **Routing**: Uses manifest exclusions (e.g., `/api/teams` excluded, served statically)
- **Headers**: Routes handled by edge functions include `x-nf-edge-functions: render`

### Timing Results
- HTTPBin direct calls worked as expected (5s delay = ~6.9s total with network overhead)
- Edge function with simple-delay showed clean linear timing:
  - 0s delay → 1.7s (cold) / 0.7s (warm)
  - 2s delay → 2.8s
  - 5s delay → 5.3s
  - 10s delay → 10.9s

### Anomalies
- `/api/test-edge` with httpbin delays showed strange behavior (1s and 5s delays both took ~8.9s)
- Likely due to complexity in that endpoint (file writes, Deno info gathering, etc.)

## Additional Testing Results

### Timeout Testing with Controlled Delays
Created test endpoints to systematically test edge function timeout behavior:
- `/api/simple-delay`: Single httpbin delay request
- `/api/test-timeout`: Sequential httpbin requests to test cumulative time

### Complete Test Results (chronological order)

| Endpoint | Expected Time | Actual Time | Success | Notes |
|----------|---------------|-------------|---------|-------|
| simple-delay?delay=0 | 0s | 1.7s | ✓ | Cold start |
| simple-delay?delay=5 | 5s | 5.3s | ✓ | |
| simple-delay?delay=2 | 2s | 2.8s | ✓ | |
| simple-delay?delay=10 | 10s | 10.9s | ✓ | |
| simple-delay?delay=0 | 0s | 0.7s | ✓ | Warm |
| test-timeout?count=4&delay=10 | 40s | 33.0s | ✗ | Failed on 4th request |
| test-timeout?count=3&delay=10 | 30s | 31.7s | ✓ | |
| test-timeout?count=3&delay=10 | 30s | 34.6s | ✓ | |
| test-timeout?count=7&delay=5 | 35s | 48.7s | ✓ | HTTPBin 5s delay takes ~9s |
| test-timeout?count=8&delay=5 | 40s | 52.7s | ✓ | |
| test-timeout?count=9&delay=5 | 45s | 57.9s | ✓ | |
| test-timeout?count=10&delay=1 | 10s | 24.3s | ✓ | |
| test-timeout?count=5&delay=10 | 50s | 60.0s | ✓ | |
| test-timeout?count=4&delay=10 | 40s | 45.1s | ✓ | Retry 1 |
| test-timeout?count=4&delay=10 | 40s | 36.4s | ✗ | Retry 2: Failed on 4th |
| test-timeout?count=4&delay=10 | 40s | 22.9s | ✗ | Retry 3: Failed on 3rd |

### Key Findings
1. **Inconsistent timeout behavior**: Same test produced different results across runs
2. **No clear timeout threshold**: Succeeded up to 60s, but sometimes failed at 23s
3. **HTTPBin timing variance**: Actual delays exceed requested (5s→9s, 10s→11-12s)

### Important Caveats
- All testing done with Netlify CLI (`netlify serve`) locally
- Production behavior may differ significantly
- Edge function behavior appears non-deterministic for long operations
- Results may be affected by local Deno runtime or CLI implementation

## Current Hypothesis

### I/O Suspension Model
**Confirmed**: Edge functions suspend execution during I/O operations without consuming the 50ms CPU budget

**Evidence**:
1. 10+ second HTTP requests complete successfully
2. If CPU time counted during I/O, would fail immediately at 50ms
3. Linear timing relationship between requested delay and actual elapsed time

### Architecture Understanding
1. **Single edge function** (`render.js`) handles all non-excluded routes
2. **I/O operations** (HTTP requests, API calls) suspend execution
3. **CPU budget** (50ms) only consumed during active processing
4. **30s timeouts** in `/api/write` occur when cumulative CPU processing hits limits across multiple operations

### Why This Works
- Edge function acts as request router/handler
- Long I/O operations (LLM API calls) don't count against CPU limits
- Allows "serverless-like" behavior within edge function constraints

## Implications for prefix-all-locales

The 500 errors with prefix-all-locales are likely NOT due to:
- Bundle size (3.4MB works fine on main)
- I/O timeout issues (proven suspension during I/O)

More likely causes:
- Additional routing complexity pushing CPU usage over 50ms limit
- Incompatibility between adapter's prerender filtering and Netlify's function routing
- Edge function initialization issues with modified routing patterns