# Selfie Upload Feature Implementation Summary
Date: 2025-09-09
Session: Selfie upload for AI safety book campaign

## What Was Built

Implemented a complete selfie upload feature for the PauseAI "If Anyone Builds It, Everyone Dies" book campaign, allowing supporters to upload photos for a collage petition.

### Key Components Created

1. **Upload Page** (`/selfie`)
   - Mobile-first responsive design
   - Statement of support shown upfront
   - Cloudinary widget integration with multiple sources (camera, local, social media)
   - Post-upload confirmation flow with email capture

2. **Server Endpoints**
   - `/api/selfie/blur` - Applies face blur by creating new blurred image
   - `/api/selfie/add-email` - Adds email to Cloudinary metadata
   - `/api/selfie/remove` - Deletes image from Cloudinary
   - Shared Cloudinary config in `/lib/cloudinary.ts`

3. **Documentation**
   - `SELFIE_SETUP.md` - Instructions for developers
   - Environment variable configuration

## Technical Decisions

### Storage: Cloudinary Instead of Airtable
- **Decision**: Use Cloudinary's metadata and tags instead of separate Airtable
- **Rationale**: Simpler architecture, no write license constraints, single source of truth
- **Implementation**: Tags for status (`pending`, `face_masked`, `has_email`), context metadata for email

### Face Detection & Cropping
- **Decision**: Server-side face detection via upload preset transformation
- **Configuration**: `c_fill,g_face,ar_3:4,w_1500,h_2000,q_auto`
- **Result**: Automatic 3:4 portrait crops centered on faces

### Blur Implementation
- **Challenge**: Can't directly replace image with transformed version in Cloudinary
- **Solution**: Upload blurred version with `_blurred` suffix, delete original
- **Implementation**: Download transformed image, re-upload with new ID

### UX Flow
- **Decision**: Upload first, options after
- **Rationale**: Reduce friction, progressive disclosure
- **Flow**: Upload → Confirmation (with blur/email options) → Done

### Authentication
- **Decision**: Hardcode cloud name and API key, only require secret
- **Rationale**: Simplifies configuration for developers
- **Shared account**: Developers can use Anthony's test account or their own

## Current Status

### Working
- Upload from multiple sources (camera, file, social media)
- Face detection and auto-crop to 3:4 portraits
- Optional face blur (creates new blurred image)
- Email capture with metadata storage
- Image removal
- Loading states and error handling

### Limitations
- Camera widget has two-step flow (capture → upload) that can't be bypassed
- Blur creates new image with `_blurred` suffix rather than in-place replacement
- Review process still manual via Cloudinary Media Library

### Next Steps (Not Implemented)
- Reviewer account setup in Cloudinary
- Webhook/polling for approved photos
- EFS sync for approved images
- Collage generation with ImageMagick
- Email notifications when photos appear in collage

## Configuration Required

### Cloudinary Dashboard
1. Create upload preset named "selfie" (unsigned)
2. Add incoming transformation: `c_fill,g_face,ar_3:4,w_1500,h_2000,q_auto`

### Environment Variables
```bash
PUBLIC_CLOUDINARY_CLOUD_NAME="dyjlw1syg"  # Or developer's own
CLOUDINARY_API_KEY="779717836612829"      # Or developer's own
CLOUDINARY_API_SECRET=""                  # Required - from Psono or own account
```

### Deployment
- Add `CLOUDINARY_API_SECRET` to Netlify environment variables
- Other values default from code

## Testing Notes

- Face detection works well with clear front-facing photos
- Mobile experience needs testing on actual devices
- Server operations require API secret to be configured
- Cloudinary free tier sufficient for development (25GB storage, 3 users)