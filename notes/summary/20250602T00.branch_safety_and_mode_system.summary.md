# Branch Safety and Mode System Implementation

**Date**: 2025-06-02
**Context**: Implementing branch-based safety for translation cache and simplifying the translation mode system

## Key Decisions Made

### 1. Translation Mode System
Replaced complex flag-based system with a clean `TranslationMode` class:
- **en-only**: No translation needed when only English locale configured
- **dry-run**: Unified read-only/dry-run modes - triggered by missing/invalid API key OR explicit flag
- **perform**: Active translation mode (renamed from "write" for clarity)

The mode is determined by:
1. Locale configuration (en-only check)
2. API key validity (< 10 chars = dry-run)
3. Explicit --dry-run flag
4. Branch + CI status (safety check)

### 2. Branch Safety Implementation
- Dynamic branch detection: env var → CI detection → current Git branch
- Main branch protection: local dev cannot write to main
- CI exception: CI/CD can write to main for production deploys
- Clear error messages with remediation options

### 3. Architectural Improvements
- Created OOP design with `TranslationMode` class
- Added `mode.announce()` for clear user communication  
- Centralized CI detection in `mode.isCI`
- Added argument validation to prevent typos
- Comprehensive unit tests

## Technical Changes

### Files Modified
- `scripts/translation/git-ops.ts`: Added branch detection and validation
- `scripts/translation/mode.ts`: New file with TranslationMode class
- `scripts/translation/mode.test.ts`: Comprehensive unit tests
- `scripts/translation/translate.ts`: Integrated mode system
- `package.json`: Updated script names and removed L10N_FORCE_TRANSLATE

### Key Functions Added
- `getTranslationBranch()`: Determines which branch to use
- `validateBranchForWrite()`: Prevents unsafe writes
- `TranslationMode.determine()`: Core mode logic
- `TranslationMode.announce()`: User-friendly output

## What Changed From Original Plan

1. **Kept dry-run mode**: Instead of removing it, unified with read-only mode
2. **Added perform mode**: More descriptive than "write" mode
3. **Created TranslationMode class**: Better architecture than scattered functions
4. **Added strict validation**: Prevents accidental translations from typos
5. **Kept --force flag**: Useful for development, replaced --mode debug

## Current Status

### Working
- Branch detection and safety validation
- Mode determination and announcement
- Argument validation
- Unit tests passing
- Basic --force flag (with hardcoded file list)

### Issues Found
- en.json symlink causes copy error in perform mode
- Translation cache branch needs upstream tracking setup
- Some "translation" terminology remains (should be "l10n")

## Next Session Focus

1. Complete l10n terminology migration throughout codebase
2. Enhance --force to accept file patterns/globs
3. Simplify pnpm targets (remove redundant ones)
4. Fix en.json symlink issue
5. Add factory method for environment-based mode construction

## Key Insights

- Mode system successfully simplifies mental model
- Branch-based safety is more intuitive than complex flags
- Clear user communication (mode announcement) reduces confusion
- OOP design with tests provides confidence for future changes
- Argument validation prevents expensive mistakes