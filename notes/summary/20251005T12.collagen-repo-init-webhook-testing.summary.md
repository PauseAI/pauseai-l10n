# Session Summary: Collagen Repository Initialization & Webhook Testing

**Date**: 2025-10-05, 12:00-16:00 UTC
**Repository**: https://github.com/PauseAI/pauseai-collagen
**Branch**: main
**Commits**: 6bb4495, 1acb4e2

## Session Goal

Initialize new GitHub repository for automated photo collage pipeline and validate Cloudinary webhook architecture through empirical testing.

## What We Accomplished

### 1. Repository Setup
- Created new Git repo in `pauseai-l10n/notes/references/pauseai-collagen/`
- Restructured documentation: README.md (public), CLAUDE.md (AI context), ORIGINAL_PROJECT_PLAN.md (reference)
- Created GitHub repo `PauseAI/pauseai-collagen`
- Created 7 tracking issues (#1-#7) for implementation phases
- Commit: 6bb4495

### 2. AWS Account & Infrastructure
- Created AWS account "PauseAI" (719154425282) with billing alerts
- Provisioned infrastructure in us-east-1:
  - EC2: i-05674280f86f51a75 (t3.micro, Ubuntu 22.04, 3.85.173.169)
  - EFS: fs-001b5fdce1b4db8c8 (mounted at /mnt/efs)
  - Security group: sg-0373b27f58f4dfa48 (SSH, HTTP, NFS)
- All reproducible via `scripts/setup-aws-infra.sh`

### 3. Webhook Testing (Phase 0)
- Deployed Flask webhook receiver on EC2
- Configured Cloudinary global webhook: `event_type: moderation`
- Empirically tested all webhook behaviors
- **Result**: Moderation webhooks fully functional ✅

### 4. Architecture Decision
**Chose webhook-based sync** over polling based on test results.

See issue #2 for complete testing documentation.

## Key Decisions Made

### Webhook Architecture Confirmed

**What triggers webhooks:**
- Any moderation status change (approved↔rejected↔pending)
- Approved→approved (no change) does NOT trigger
- Both UI and API approvals trigger webhooks

**Backfill strategy:**
- Set existing approved photos to pending via API
- Re-approve via API
- Each triggers webhook → processor syncs to EFS
- Total: 2 API calls per photo (284 calls for 142 photos, ~5 min)

**Processing approach:**
1. Webhook arrives with public_id, moderation_status, URLs
2. Fetch metadata via API (includes context.custom.email)
3. Download image from secure_url
4. Embed email in EXIF using exiftool
5. Save to `/mnt/efs/{asset_folder}/approved/`

### Infrastructure Evolution

**Phase 1** (next session): EC2 direct webhook processing
- Fast iteration for dev testing
- Process only `asset_folder=test_prototype`
- Current webhook receiver serves this purpose

**Phase 2** (before prod): API Gateway + SQS
```
Cloudinary → API Gateway → SQS → EC2 Processor → EFS
              (VTL mapping)     (message attrs)
```
- API Gateway VTL extracts `asset_folder` → SQS message attribute `campaign`
- Enables per-campaign CloudWatch alarms (dev/prod separation)
- EC2 polls SQS (not Lambda - EFS already mounted)
- 14-day message retention, DLQ for failures

### Campaign-Agnostic Design

**EFS structure:** `/mnt/efs/{asset_folder}/` not `/mnt/efs/{dev|prod}/`
- `test_prototype/` for dev
- `sayno/` for production
- Future campaigns just add folders

Processor routes based on webhook `asset_folder` field.

## Technical Findings

### Cloudinary Behavior
- Webhook retries: 3 attempts, 3-min intervals, 20-sec timeout (9-min total window)
- Moderation webhook payload lacks email metadata (must fetch separately)
- Upload presets CAN include notification_url but global webhook simpler
- Cloudinary doesn't write custom metadata to EXIF (we handle with exiftool)

### AWS Learnings
- Ubuntu 22.04 has Python 3.10 (not 3.12) - updated scripts
- EFS requires port 2049 (NFS) in security group
- Dynamic IPs require security group updates for SSH
- Port 80 requires nginx proxy (Flask can't bind as non-root)
- User-data only runs on first boot (failed packages need manual fix)

## Files Created

**Infrastructure:**
- `scripts/setup-aws-infra.sh` - Provisions all AWS resources
- `scripts/setup-ec2.sh` - Mounts EFS, creates directories
- `config.py` - Cloudinary public config (cloud name, API key)
- `.gitignore` - Updated for .env, .aws-config

**Webhook Testing:**
- `scripts/webhook-receiver.py` - Flask app for logging webhooks
- `scripts/webhook-receiver.service` - systemd service
- `scripts/nginx-webhook.conf` - Reverse proxy config

**Documentation:**
- CLAUDE.md - Updated with test results, architecture decision
- Issue #2 - Complete webhook test documentation

## Current State

**AWS Resources Running:**
- EC2 instance with webhook receiver active
- Global Cloudinary webhook configured (moderation events)
- EFS mounted with campaign directories ready
- Costs: ~$9/month (within budget)

**Ready for Phase 1:**
- Implement EC2-based webhook processor
- Filter by `asset_folder` (test_prototype only initially)
- Test complete dev workflow (sync → collage → email)
- Then migrate to API Gateway + SQS (Phase 2)

## Next Session

Start with:
1. Read CLAUDE.md for current status
2. Review issue #3 (Phase 1A implementation)
3. Implement webhook processor with:
   - Fetch metadata + download image
   - Embed email in EXIF
   - Save to `/mnt/efs/{asset_folder}/approved/`
   - Handle rejections (delete from EFS)
4. Improve log file naming format

## Open Questions for Next Time

- Admin webapp domain/hosting (`collage-admin.pauseai.info`?)
- Collage serving location (`pauseai.info/collages/`?)
- Email template finalization (maximize single-contact value)
- GDPR compliance (unsubscribe mechanism)

## References

- Repository: https://github.com/PauseAI/pauseai-collagen
- Issue #2: https://github.com/PauseAI/pauseai-collagen/issues/2
- Commits: 6bb4495 (init), 1acb4e2 (Phase 0)
- Related: PauseAI/pauseai-website#436, #437, #488, #500
