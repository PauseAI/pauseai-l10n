# Prefix-All-Locales 500 Error Investigation

**Date**: 2025-06-23  
**Branch**: `investigate/500s`  
**Context**: Investigating 500 errors when implementing prefix-all-locales routing strategy

## Changes Made During Investigation

### 1. Adapter Patch Modifications (`src/lib/adapter-patch-prerendered.js`)

**Initial state**: Basic adapter patch filtering prerendered paths by locale prefix

**Change 1**: Added redirect generation
- Filtered out paths not starting with locale prefixes
- Added filtered paths to `_redirects` file with destination `/.netlify/functions/sveltekit-render 200!`

**Change 2**: Added edge function support
- Added conditional destination based on `USE_EDGE_FUNCTIONS`
- Edge functions: `/.netlify/edge-functions/render`
- Serverless functions: `/.netlify/functions/sveltekit-render`

**Change 3**: Excluded API routes from redirects
- Added condition: `if (path.startsWith('/api/')) return false`
- API routes no longer added to redirects but still filtered from prerendered paths

**Final state on main**: Adapter patch logic completely commented out

### 2. SvelteKit Configuration (`svelte.config.js`)

**Change**: Added `paths: { relative: false }`
- Purpose: Force absolute asset paths to prevent `/en/_app/` style broken links

**Change**: Modified `USE_EDGE_FUNCTIONS` from `false` to `true`
- Switched from serverless to edge functions for testing

### 3. Redirect File Management

**Initial**: `_redirects` contained only domain redirect: `https://pauseai.org/* https://pauseai.info/:splat 301!`

**During investigation**: File accumulated multiple entries from repeated builds
- Found 5 duplicate entries for `/api/teams` redirects
- File grew to 600+ lines with duplicate redirects

**Restoration**: Cleaned back to original single domain redirect

## Observations

### HTTP Response Patterns

**API Routes on investigate/500s branch**:
- `/api/teams`: 500 Internal Server Error
- `/api/calendar`: 500 Internal Server Error  
- Response headers included: `x-nf-edge-functions: render`

**API Routes on main branch**:
- `/api/teams`: 200 OK
- Content-type: application/octet-stream
- Content-length: 3621

**Localized Routes on investigate/500s**:
- `/en/`: 200 OK
- Content-length: 44344
- Note: likely served from static prerendered files, not edge function

**Unlocalized Routes on investigate/500s**:
- `/`: 500 Internal Server Error
- Response headers included: `x-nf-edge-functions: render`

### Build Behavior

**Redirect counting**:
- Initial builds: 100 force redirects
- After API exclusion: 97 force redirects  
- Confirmed 3 API routes were excluded

**Manifest behavior**:
- Edge functions skipped manifest updates (logged: "Edge functions enabled - skipping manifest update")
- Serverless functions wrote to `.netlify/server/manifest.js`

**_redirects file behavior**:
- Build warning: "A '_redirects' file is present in the repository but is missing in the publish directory 'build'"
- `netlify serve` reads from repo root, reacts to changes with "Reloading redirect rules"
- Build directory does not contain `_redirects` file

### Runtime Configuration Differences

**Main branch runtime.js**:
- English mapped to root pattern: `":protocol://:domain(.*)::port?/:path(.*)?"` 
- Other locales use prefix patterns
- URLPattern polyfill disabled: `const URLPattern = {}`

**investigate/500s runtime.js** (during prefix-all-locales testing):
- All locales including English used prefix patterns
- English: `":protocol://:domain(.*)::port?/en/:path(.*)?"` 
- URLPattern polyfill disabled: `const URLPattern = {}`

### Edge Function Manifest

**Main branch manifest**:
- API routes explicitly excluded: `/api/posts`, `/api/signatories`, `/api/teams`
- Edge function path: `/*` with extensive exclusion list

**investigate/500s manifest**:
- Similar structure but generated with different prerendered path filtering

## Testing Sequence

1. **Edge functions with prefix-all-locales**: 500 errors on all non-prerendered routes
2. **Serverless functions with prefix-all-locales** (earlier): Working responses with redirects functioning
3. **Edge functions on main branch**: 200 OK responses for API routes
4. **Asset path testing**: Fixed broken relative paths with `paths.relative: false`

## Error Patterns

**Consistent 500 errors occurred**:
- On edge functions with prefix-all-locales strategy
- For both API routes and regular page routes
- Despite different redirect configurations
- Even after cleaning _redirects file

**No 500 errors occurred**:
- On main branch with standard routing
- For prerendered localized routes (e.g., `/en/`)

## File States

**Scripts and configuration files modified**: adapter-patch-prerendered.js, svelte.config.js  
**Generated files modified**: runtime.js, edge function manifests, _redirects  
**Source control status**: _redirects tracked but modified during builds

## Analysis of Change Dependencies

**Serverless function success factors**:
- Multiple changes were made before serverless functions worked with prefix-all-locales
- Unknown which subset of changes was necessary for success
- `_redirects` file generation was the final change before functionality worked
- Adapter patch manifest filtering may have been equally important
- Runtime.js URL pattern changes likely irrelevant (only affected default path handling)

**Edge function failure factors**:
- When switching to edge functions, corresponding changes were largely guesswork
- Redirect destination changed from `/.netlify/functions/sveltekit-render` to `/.netlify/edge-functions/render` without documentation reference
- Manifest file handling differs between edge and serverless functions:
  - Adapter patch skipped manifest updates for edge functions
  - Unknown if edge functions read manifests from same locations as serverless functions
- No systematic verification that edge function routing worked the same way as serverless routing

**Key uncertainty**: Whether edge function 500 errors were due to incorrect redirect destinations, incorrect manifest handling, or fundamental incompatibility with prefix-all-locales strategy