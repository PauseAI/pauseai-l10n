# Phase 2B Validation and Email Preparation

**Date**: 2025-10-23
**Session**: Laptop recovery, Phase 2B validation, production collage build
**Repository**: pauseai-collagen
**Status**: Phase 2B complete and deployed, ready for Phase 3 (email notifications)

## Context

Developer's laptop hardware failed recently. Last session (2025-10-13) completed Phase 2B implementation but code was pushed as emergency backup without full validation or deployment. This session focused on:
1. Recovering work from failing laptop
2. Validating Phase 2B code
3. Fixing discovered bugs
4. Building production collage
5. Preparing for Phase 3 (email notifications)

## Major Accomplishments

### 1. Version Control Recovery
- Backed up Claude Code config to SVN (bin/update script, notes/CLAUDE.md)
- Pushed emergency chat transcripts to pauseai-l10n (265k+ lines, secrets redacted)
- Amended pauseai-collagen commit with proper Phase 2B documentation
- Cleaned up duplicate files

### 2. Environment Configuration
- Created lib/config.py with COLLAGEN_DATA_DIR environment variable
- Unified dev (/tmp/collagen-local) and prod (/mnt/efs) contexts
- Updated all Phase 2B code to use centralized configuration
- **Commit**: 575a201

### 3. Bug Fixes

#### JPEG Crop Bug (f37a3ec)
- **Problem**: JPEG derivatives had white strips due to cropping from (0,0) instead of accounting for centered padding
- **Fix**: Calculate offset_x/offset_y based on (target_size - collage_size) / 2
- **Validation**: Tested on EC2 with both horizontal and vertical padding scenarios

#### Tile Selection Bug (1ce063b)
- **Problem**: When optimizer reduces tile count (277→266), code selected all 277 tiles, causing montage to paginate into 4096-0.png + 4096-1.png
- **Root cause**: Montage auto-paginates when input count exceeds tile grid slots
- **Investigation**: Discovered via EC2 testing; debugged ImageMagick resource limits
- **Fix**: Use layout['used_images'] instead of n_images when selecting tiles
- **Also fixed**: Misleading log message now shows actual images used

### 4. Production Deployment
- Deployed Phase 2B code to EC2 via scp (lib/, tools/)
- Set up COLLAGEN_DATA_DIR=/mnt/efs on EC2
- Built production collage: **20251024T230728Z,266=19x14**
  - 266 images from 281 available tiles
  - 19×14 grid (optimizer chose to omit 11 images from 277 due to prime factorization)
  - Clean email uniqueness: 245 unique emails, 21 nulls, 0 duplicates
  - Build time: ~2m23s (acceptable for periodic manual builds)

### 5. Utilities Created
- **tools/fetch_from_ec2.py**: Copy files from EC2 EFS to local equivalent paths
- **tools/show_all_layouts.py**: Display all layout options with score breakdowns (omit_cost + fit_cost)

## Key Decisions

### Prioritize Email Over Webapp UI
- **Decision**: Build collages via CLI, not webapp UI (for now)
- **Rationale**: 266 people waiting for promised emails; CLI works fine for periodic builds
- **Webapp scope revised**: Will be used for email validation tracking, not collage building
- **Timeline impact**: Unblocks Phase 3 immediately

### Manual Duplicate Handling
- Current approach: Manual curation in Cloudinary (reject lower quality duplicates)
- Example: Rejected sayno/selfie_1759868631235_vkqnjt in favor of sayno/ijqgjn9uxn3v4x4qvh9q (same email, cleaner background)
- Defers issue #8 (automated deduplication) to future enhancement

## Technical Learnings

### ImageMagick Montage Pagination
- Montage creates multiple output files when input count > tile grid slots
- Not related to command-line length limits (ARG_MAX = 2MB, only needed ~20KB)
- Not the ImageMagick policy.xml file limit (was 768 on EC2)
- Root cause: Passing 277 renders with `-tile 19x14` (266 slots)
- Debug logging (-debug all) was too verbose (42K lines) and uninformative

### Grid Optimizer Behavior
- For prime numbers like 277, optimizer finds nearest factorable number
- 277 → 266 (19×14) scored better than 276 (23×12) due to fit costs
- Scores combine: omit_cost (1500 × omit_fraction) + fit_cost (padding + clipping pixels)

### Performance
- Test collage (20 tiles): ~40-48s
- Production collage (266 tiles): ~2m23s
- Acceptable for manual/periodic builds (not web request)

## Current State

### Infrastructure
- EC2 instance: 3.85.173.169 (Edinburgh home IP added to security group)
- EFS mount: /mnt/efs with 281 sayno tiles, 20 test_prototype tiles
- Deployed code: Phase 2B lib/ and tools/ (no webapp/ yet)
- Ingestor: Running, 277→281 tiles since last check

### Collages
- Production: 20251024T230728Z,266=19x14 ready for email distribution
- Manual collages already published on website:
  - manual_bootstrap.jpg (1920×1920, ~130 people, already emailed)
  - manual_bootstrap_246.jpg (1920×1920, ~246 people, built by Tom)
  - manual_2.jpg (1100×1100)

### Email Requirements (from issue #488)
Approved template by Ella:
- Personal greeting
- Link to collage with embedded image
- Social sharing affordances
- Two CTAs:
  1. Verify email + newsletter + more ways to help (encouraged)
  2. Just verify email, no further contact (opt-out)
- Email hash in links for tracking
- Deferred: Personalized collage view with face highlighting

## Next Session Priorities

### Phase 3A: Email Notification System
1. Implement email template (HTML + plain text)
2. Email hash generation for tracking links
3. SMTP integration (sayno@pauseai.info via Google Workspace)
4. Dry-run and test modes
5. Send to all 266 collage participants (including 130 bootstrap folks with context note)

### Phase 3B: Email Tracking Webapp
1. Validation endpoint (/validate/{email_hash})
2. Opt-in tracking (newsletter, further contact)
3. Admin dashboard for validation stats
4. Deploy to EC2 alongside CLI tools

## Files Modified This Session

### Commits
- 575a201: Add environment-aware configuration
- f37a3ec: Fix JPEG crop bug
- 1ce063b: Fix tile selection bug, add utilities
- ceb3175: Update CLAUDE.md status

### Tools Created
- lib/config.py: Environment-aware DATA_DIR configuration
- tools/fetch_from_ec2.py: EFS file retrieval utility
- tools/show_all_layouts.py: Layout score inspection tool

### Documentation
- Updated CLAUDE.md: Current status, production build ID, Phase 3 focus
- Issue #5: Posted validation complete status
- Issue #7: Documented prioritization shift (email before webapp UI)

## Open Questions for Next Session

1. Email content finalization (based on Ella's approved template)
2. Tracking implementation (validation, opt-in, opens, clicks)
3. Test group selection (dry-run → pauseai.info addresses → small group → full send)
4. Context note for 130 bootstrap folks who already received personal email
5. Unsubscribe/GDPR compliance mechanism
