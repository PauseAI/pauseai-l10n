# Edge Function 500 Error Investigation Summary

## Session: 2025-06-18T18:00

### Objective
Reproduce and investigate sporadic 500 errors on the `/statement` route in production.

### Setup
- Branch: main
- Configuration: `PARAGLIDE_LOCALES=en` (English-only mode)
- Server: `NODE_ENV=production netlify serve --port 8890`
- Working directory: `/home/anthony/repos/pauseai-l10n/notes/references/pauseai-website/`

### Key Discoveries

#### 1. Initial Investigation
- The `/statement` route fetches data from `/api/signatories` which uses Airtable
- API endpoint has error handling that returns 200 with fallback data on failures
- This ruled out API-level errors as the cause of 500s

#### 2. Edge Function Process Behavior
- Netlify serve uses Deno runtime for edge functions locally (same as production)
- Edge functions run as separate Deno processes on different ports
- Multiple edge function processes can accumulate if not properly cleaned up

#### 3. Process Termination Testing
Successfully reproduced 500 errors by killing edge function processes:

**Manual process killing:**
- `kill <PID>` → edge function dies → subsequent requests return 500

**Code-triggered termination:**
- Created `/api/test-edge-crash` endpoint with multiple crash methods
- `process.exit(1)` → kills process → 500s
- `Deno.exit(1)` → kills process → 500s  
- Stack overflow → process survives, returns 500 for that request only
- Memory exhaustion/infinite loops → not tested (system safety concern)

#### 4. Behavior After Edge Function Death
- Static/prerendered routes: Continue working (200)
- Dynamic routes requiring edge functions: Fail with 500
- Response times for 500s: ~3ms (matching production symptoms)
- Edge function process does not automatically restart

### Technical Details

#### Environment Differences
- Local: `NODE_ENV` not set by default, `CI` not set
- Production: `NODE_ENV=production`, `CI=true`
- Both use Deno runtime for edge functions
- AsyncLocalStorage disabled via `disableAsyncLocalStorage: true` in config

#### Working Crash Code
```typescript
// Deno environment
if (typeof Deno !== 'undefined' && Deno.exit) {
    Deno.exit(1)
}

// Node-compatible environment  
if (typeof process !== 'undefined' && process.exit) {
    process.exit(1)
}
```

### Conclusions
1. Production 500 errors are likely caused by edge function process termination
2. Once an edge function process dies, it doesn't automatically restart
3. This explains the sporadic nature - processes crash occasionally then get restarted by Netlify infrastructure
4. Simple JavaScript errors don't kill the process, but exit calls do

### Next Steps
- Investigate what might cause edge function processes to exit in production
- Look for unhandled promise rejections or timeout handlers
- Consider monitoring edge function health/restarts in production
- Review third-party dependencies that might call process.exit()

### Files Modified
- `/src/routes/api/test-edge-crash/+server.ts` - Created crash test endpoint
- `.env` - Added `PARAGLIDE_LOCALES=en`
- GitHub issue #19 - Added findings comment

### Logs Created
- `netlify-serve-production-mode.log`
- `netlify-serve-crash-test.log`
- `netlify-serve-crash-methods.log`
- `netlify-serve-deno-test.log`